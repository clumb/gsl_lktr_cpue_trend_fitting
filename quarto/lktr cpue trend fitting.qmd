---
title: "GSL CPUE exploratory visualization"
author: "chelsey lumb"
format: html
editor: visual
---

## Setup
 Jan 8 2026 
 Data file "lktr cpue figs and coney all areas 2011 to 2023 updated.csv" copied from       
 C:\Users\LumbC\Documents\R\gls_lktr_cpue
 
 See notes about analysis options in "Notes about LKTR res doc revisions 04DEC2025.docx" in folders            
 C:\Users\LumbC\OneDrive - DFO-MPO\CSAS\GSL SA 2024\LKTR\Notes about revisions 

## Plan
 1. Read in data from csv file (note: only lktr in csv file)
 2. Exploratory plots (box plots) - CPUE by year for FIH and FIGS (IW and IE combined), npue and bpue (outliers?)
 3. Calculate mean cpue for npue and bpue by year for FIH and FIGS (IW and IE combined)
 4. Use Validation Error (Root Mean Squared Error on hold out or validation data set) to methodically determine what span is best to use for LOESS. Have to specify the degree of the polynomial to fit locally (2 for quadratic)?
 5. Fit LOESS regression for each group of means - npue and bpue by year for FIH and FIGS (IW and IE combined)
 6. Make plots to visualize results and for res doc
 - Plot means with trend line
 - Include 95% confidence intervals
 7. Save plots to files
 

```{r}
#| label: load packages
#| include: false


library(tidyverse)
library(janitor) 
library(here)
```


```{r}
#| label: load data
#| include: false

df_original <- read.csv(here("data", "lktr cpue figs and coney all areas 2011 to 2023 updated.csv"))

df <- df_original |>
  clean_names() 


glimpse(df)

```


```{r}
#| label: CG's theme for boxplots
#| include: false

# code originally copied from GBL bio 31JAN2022.R, lines 180-198 (theme_boxplot) 
# from folders C:\Users\LumbC\Desktop\GBL\R\CG GBL bio code Nov 2021

 theme_boxplot <-
  theme_light()+ # can put size for text if you don't detail it below, for example: base_size= 14
  theme(panel.grid.major = element_blank(), #or if you want colour: element_line("blue")
        panel.grid.minor = element_blank(), #or if you want colour: element_line("blue")
        panel.border =  element_rect(colour = "black", fill=NA, size= 1), # can add ", size= 2" for bigger border; or if no                                                                             border: element_blank()
        panel.background = element_blank(),
        #plot.title = element_text(size = 14, family = "Tahoma", face = "bold"),
        #text=element_text(family = "Tahoma"), #this determine font
        axis.title = element_text(size = 12), # if you want bold: element_text(face="bold")
        axis.text.x = element_text(angle= -90, vjust=0.5, colour="black", size = 12, margin = margin(5, 0, 5, 0)), #margin                                                                                             order: top, right, bottom, left
        axis.text.y = element_text(colour="black", size= 12, margin = margin(0, 5, 0, 5)),
        axis.text.y.right = element_text(colour="black", size= 12, margin = margin(0, 5, 0, 5)), #Secondary axis if needed
      #  axis.line = element_line(size=0.5, colour = "black"),
        axis.line = element_line(linewidth=0.5, colour = "black"),  # updated to use linewidth() instead of size= for element_line()
      #  axis.ticks = element_line(colour="black", size = 0.5),
        axis.ticks = element_line(colour="black", linewidth = 0.5), # updated to use linewidth() instead of size= for element_line()
      #  axis.rect = element_rect(linewidth=0.5, colour="black"), # copilot suggested this addtional line of code element_rect()
  
        legend.key.size = unit(0.5, "cm"), #change size of legend symbols
        legend.key.width = unit(0.5,"cm"), #change width of legend symbols
        legend.title = element_text(size = 12), #color, size, face
        legend.text = element_text(size = 12)) #color, size, face
 

```


# Exploratory plots
## LKTR NPUE FIH IW and IE combined


```{r}
#| label: LKTR NPUE FIH IW and IE combined
#| include: true
#| echo: false
#| message: false
#| warning: false
#| fig.cap: "Catch per unit effort (NPUE) plots for FIH survey in IW and IE areas combined." 


# code copied from GSL LKTR trends.qmd, Age box plot (used CG's theme_boxplot) 
# from folders C:\Users\LumbC\Documents\R Projects\GSL-LKTR-trends

# modified code using CANchat GPT 4o 


# Filter the data based on the specified criteria
filtered_data <- df %>%
  filter(area %in% c("IW", "IE"),   # Filter for area IW or IE
         survey == "FIH",           # Filter for survey FIH
         valid_set == "Y")          # Filter for valid_set = Y


# Create a box plot using ggplot2

# boxplot - line is median (Q2), box is interquartile range, bottom of box is 25th percentile (Q1), top of box is 75th (QQ3)
# whiskers are 1.5*IQR, min and max
# https://r-graph-gallery.com/boxplot.html

npue_fih_iwie_boxplot <- filtered_data %>%

ggplot(aes(x = factor(year), y = lktr_npue_num_per100m2_per24h)) +
  geom_boxplot(fill = "lightblue", color = "darkblue") + # Add box plot with custom colors
  labs(
    x = "Year",
    y = "NPUE (Number per 1000 m² per 24h)"
  ) +
  theme_minimal() + # Use a clean, minimal theme, overides theme_boxplot here 
  theme(
    plot.title = element_text(hjust = 0.5, size = 14),  # Center the title and adjust size
    axis.text.x = element_text(angle = 45, hjust = 1)   # Rotate x-axis labels for clarity
  )

 print(npue_fih_iwie_boxplot)


# ggsave(here("figures", "npue_fih_iwie_boxplot.jpg"), npue_fih_iwie_boxplot,
#    width = 180, height = 120, units = "mm") 
 
 
# Group by year and calculate mean or summary statistics for lktr_npue_num_per100m2_per24h
summary_data <- filtered_data %>%
  group_by(year) %>%
  summarise(mean_npue = mean(lktr_npue_num_per100m2_per24h, na.rm = TRUE),
            sd_npue = sd(lktr_npue_num_per100m2_per24h, na.rm = TRUE),  # Optional: Standard deviation
            count = n())  # Optional: Number of observations per year

# Visualize the data using ggplot2
ggplot(summary_data, aes(x = year, y = mean_npue)) +
  geom_line(color = "blue", size = 1) +  # Line plot
  geom_point(color = "red", size = 2) + # Add points for individual years
  geom_errorbar(aes(ymin = mean_npue - sd_npue, ymax = mean_npue + sd_npue), 
                width = 0.2, color = "gray") + # Optional: Error bars
  labs(x = "Year",
       y = "Mean NPUE (Number per 1000 m² per 24h)") +
 # scale_x_continuous(breaks = unique(filtered_data$year)) +  # Ensure every unique year is labeled
  theme_minimal()  # Use a clean, minimal theme, overides theme_boxplot here

```

